services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    networks:
      - proxy
    ports:
      - ${TRAEFIK_IP}:8022:8022
      - ${TRAEFIK_IP}:6379:6379
      - ${TRAEFIK_IP}:443:443
      - ${TRAEFIK_IP}:8443:8443
    volumes:
      - traefik-config:/etc/traefik
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL=${ACME_EMAIL}
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_STAGING_ACME_EMAIL=${ACME_EMAIL}
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - komodo.skip=true
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.services.traefik.loadbalancer.server.port=8080
      - traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN}`)
      - traefik.http.routers.dashboard.entrypoints=https
      - traefik.http.routers.dashboard.tls.certresolver=letsencrypt-staging
      - traefik.http.routers.dashboard.tls.domains[0].main=${DOMAIN}
      - traefik.http.routers.dashboard.tls.domains[0].sans=*.${DOMAIN}
      - traefik.http.routers.dashboard.tls=true
      - traefik.http.routers.dashboard.tls.certresolver=letsencrypt
      - traefik.http.routers.dashboard.service=api@internal
      - traefik.http.routers.dashboard.middlewares=security-headers
      - traefik.http.middlewares.security-headers.headers.sslRedirect=true
      - traefik.http.middlewares.security-headers.headers.stsSeconds=31536000
      - traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.security-headers.headers.stsPreload=true
      - traefik.http.middlewares.security-headers.headers.forceSTSHeader=true
      - traefik.http.middlewares.security-headers.headers.frameDeny=true
      - traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.security-headers.headers.browserXssFilter=true
      - traefik.http.middlewares.security-headers.headers.referrerPolicy=same-origin
      - traefik.http.middlewares.security-headers.headers.customFrameOptionsValue=SAMEORIGIN
      - traefik.http.middlewares.unifiHeaders.headers.customRequestHeaders.Authorization=
      - traefik.http.middlewares.ratelimit.rateLimit.average=100
      - traefik.http.middlewares.ratelimit.rateLimit.burst=50
      - traefik.http.middlewares.ratelimit.rateLimit.period=1s

  forgejo:
    image: codeberg.org/forgejo/forgejo:13
    container_name: forgejo
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=postgres
      - FORGEJO__database__HOST=forgejo-db:5432
      - FORGEJO__database__NAME=forgejo
      - FORGEJO__database__USER=forgejo
      - FORGEJO__database__PASSWD=forgejo
    restart: always
    networks:
      - forgejo
      - proxy
    volumes:
      - forgejo-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - forgejo-db
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # HTTP router for web UI
      - "traefik.http.services.git.loadbalancer.server.port=3000"
      - "traefik.http.routers.git.rule=Host(`git.${DOMAIN}`)"
      - "traefik.http.routers.git.entrypoints=https"
      - "traefik.http.routers.git.tls=true"
      # TCP router for SSH
      - "traefik.tcp.routers.git-ssh.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.git-ssh.entrypoints=git-ssh"
      - "traefik.tcp.routers.git-ssh.service=git-ssh"
      - "traefik.tcp.services.git-ssh.loadbalancer.server.port=22"

  forgejo-db:
    image: postgres:14
    restart: always
    container_name: forgejo-db
    environment:
      - POSTGRES_USER=forgejo
      - POSTGRES_PASSWORD=forgejo
      - POSTGRES_DB=forgejo
    networks:
      - forgejo
    volumes:
      - forgejo-db:/var/lib/postgresql/data
      
  forgejo-runner:
    image: ghcr.io/capsmanyo/forgejo-runner:latest
    container_name: forgejo-runner
    environment:
      DOCKER_HOST: unix://docker-in-docker:2375
    # User without root privileges, but with access to `./data`.
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - forgejo-runner:/data
    user: 1001:1001
    networks:
      - forgejo
    restart: 'unless-stopped'
    command: '/bin/sh -c "while : ; do sleep 1 ; done ;"'

  portainer:
    container_name: portainer
    image: portainer/portainer-ee:lts
    restart: always
    privileged: true
    networks:
      - proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.portainer.loadbalancer.server.port=9443"
      - "traefik.http.services.portainer.loadbalancer.server.scheme=https"
      - "traefik.http.routers.portainer.rule=Host(`portainer.${DOMAIN}`)"
      - "traefik.http.routers.portainer.entrypoints=https"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.routers.portainer.service=portainer"

  code-server:
    image: lscr.io/linuxserver/code-server:latest
    container_name: code-server
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
      - DEFAULT_WORKSPACE=/config/workspace #optional
      - PWA_APPNAME=code-server #optional
    volumes:
      - ./code-server:/config
      - ../:/config/workspace
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.code.loadbalancer.server.port=8443"
      - "traefik.http.routers.code.rule=Host(`code.${DOMAIN}`)"
      - "traefik.http.routers.code.entrypoints=https"
      - "traefik.http.routers.code.tls=true"
      - "traefik.http.routers.code.service=code"

volumes:
  forgejo-data:
    external: true
  forgejo-db:
    external: true
  forgejo-runner:
    name: forgejo-runner
  portainer-data:
    external: true
  traefik-config:
    external: true

networks:
  proxy:
    external: true
  forgejo:
    external: false
